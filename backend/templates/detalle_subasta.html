{% extends "base.html" %}
{% block title %}Detalle de Subasta{% endblock %}

{% block content %}
<h1 class="text-4xl font-bold neon mb-6">Detalles de la Subasta</h1>

<div id="detalle" data-subasta="{{ subasta_id }}" class="card p-6 rounded-xl mb-6"></div>

<h2 class="text-2xl font-bold neon mb-4">Realizar Puja</h2>
<div class="card p-6 rounded-xl max-w-md">
  <form id="puja-form" class="space-y-4">
    <div>
      <label>Monto de tu puja</label>
      <input id="monto" type="number" step="0.01" class="w-full p-2 rounded bg-black/40 border border-white/10" required>
    </div>
    <button class="w-full bg-cyan-500 hover:bg-cyan-600 text-black font-bold py-2 rounded-lg">Pujar</button>
  </form>
</div>

<script>
  /* Leemos el id desde el atributo data- del elemento */
  const subastaId = Number(document.getElementById("detalle").dataset.subasta);

  async function cargarDetalle() {
    const res = await fetch(`/api/subastas/${subastaId}`);
    const s = await res.json();

    const cont = document.getElementById("detalle");
    cont.innerHTML = `
      <h2 class="text-3xl font-bold mb-2">${s.titulo}</h2>
      <p class="text-gray-300">${s.descripcion}</p>
      <p class="mt-4 font-semibold">Precio actual: <span id="precio-actual" class="text-cyan-300">$${s.precio_actual}</span></p>
    `;
  }

  cargarDetalle();

  /* WebSocket para actualizaciones en tiempo real */
  const socket = new WebSocket(`ws://localhost:8000/ws/${subastaId}`);
  socket.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.tipo === "nueva_puja") {
      document.getElementById("precio-actual").textContent = `${msg.nuevo_precio}`;
    }
  };

  /* IMPORTANTE: Cerrar WebSocket cuando se sale de la página */
  window.addEventListener('beforeunload', () => {
    socket.close();
  });

  /* Enviar puja */
  const formPuja = document.getElementById("puja-form");
  formPuja.addEventListener("submit", async (e) => {
    e.preventDefault();

    const body = {
      subasta_id: subastaId,
      monto: parseFloat(document.getElementById("monto").value)
    };

    const res = await fetch(`/api/pujas`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (res.ok) {
      alert("¡Puja realizada con éxito!");
      document.getElementById("monto").value = "";
      cargarDetalle();
    } else {
      const error = await res.json();
      alert(error.error || "La puja no fue válida. Debe ser mayor al precio actual.");
    }
  });
</script>
{% endblock %}